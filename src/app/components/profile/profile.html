<div class="profile-container">
  @if (isLoading()) {
    <div class="loading-container">
      <div class="spinner"></div> <p class="loading-text">Loading profile data...</p>
    </div>
  }

  @if (!isLoading()) {
    <div class="profile-content" [class.form-saving]="isSaving()">
      <form [formGroup]="profileForm" (ngSubmit)="onSubmit()">
        
        <div class="profile-pic-container">
          <div class="profile-pic-wrapper" (click)="toggleImageOptions()">
            <div class="avatar">
              @if (getCurrentImageUrl()) {
                <img 
                  [src]="getCurrentImageUrl()" 
                  alt="Profile Picture"
                  class="avatar-image"
                />
              } @else {
                <div class="avatar-placeholder">
                  <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                  </svg>
                </div>
              }
            </div>
            <div class="camera-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                <circle cx="12" cy="13" r="4"></circle>
              </svg>
            </div>
          </div>

          @if (showImageOptions()) {
            <div class="image-options-modal" (click)="toggleImageOptions()">
              <div class="image-options-content" (click)="$event.stopPropagation()">
                <label class="option-item">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                  </svg>
                  <span>Gallery</span>
                  <input type="file" accept="image/*" (change)="onFileSelected($event)" hidden>
                </label>
                
                <label class="option-item">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                    <circle cx="12" cy="13" r="4"></circle>
                  </svg>
                  <span>Camera</span>
                  <input type="file" accept="image/*" capture="environment" (change)="onFileSelected($event)" hidden>
                </label>

                @if (selectedImagePreview() || profilePicUrl()) {
                  <div class="option-item option-item-danger" (click)="removeImage()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    <span>Remove Photo</span>
                  </div>
                }
              </div>
            </div>
          }
        </div>

        <div class="form-group">
          <label for="fullName">Full Name</label>
          <input 
            id="fullName"
            type="text" 
            formControlName="fullName"
            class="form-control"
            [class.error]="profileForm.get('fullName')?.invalid && profileForm.get('fullName')?.touched"
          />
          @if (profileForm.get('fullName')?.invalid && profileForm.get('fullName')?.touched) {
            <span class="error-message">Please enter your full name</span>
          }
        </div>

        <div class="form-group">
          <label for="nationalId">National ID</label>
          <input 
            id="nationalId"
            type="text" 
            formControlName="nationalId"
            class="form-control"
            [class.error]="profileForm.get('nationalId')?.invalid && profileForm.get('nationalId')?.touched"
          />
          @if (profileForm.get('nationalId')?.invalid && profileForm.get('nationalId')?.touched) {
            <span class="error-message">Please enter your national ID</span>
          }
        </div>

        <div class="form-group">
          <label for="phone">Phone Number</label>
          <div class="input-with-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="input-icon">
              <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
            </svg>
            <input 
              id="phone"
              type="tel" 
              formControlName="phone"
              placeholder="0712345678 or 254712345678"
              class="form-control with-icon"
              [class.error]="profileForm.get('phone')?.invalid && profileForm.get('phone')?.touched"
            />
          </div>
          @if (profileForm.get('phone')?.invalid && profileForm.get('phone')?.touched) {
            <span class="error-message">Invalid phone number format</span>
          }
        </div>

        <div class="form-group">
          <label for="county">County</label>
          <select 
            id="county"
            formControlName="county"
            class="form-control"
            [class.error]="profileForm.get('county')?.invalid && profileForm.get('county')?.touched"
          >
            <option value="">Select County</option>
            @for (region of regions; track region.county_code) {
              <option [value]="region.county_name">
                {{ region.county_name }}
              </option>
            }
          </select>
          @if (profileForm.get('county')?.invalid && profileForm.get('county')?.touched) {
            <span class="error-message">Please select a county</span>
          }
        </div>

        <div class="form-group">
          <label for="constituency">Constituency</label>
          <select 
            id="constituency"
            formControlName="constituency"
            class="form-control"
            [class.error]="profileForm.get('constituency')?.invalid && profileForm.get('constituency')?.touched"
          >
            <option value="">
              {{ !profileForm.get('county')?.value ? 'Select county first' : 'Select Constituency' }}
            </option>
            @for (constituency of constituencies; track constituency) {
              <option [value]="constituency">
                {{ constituency }}
              </option>
            }
          </select>
          @if (profileForm.get('constituency')?.invalid && profileForm.get('constituency')?.touched) {
            <span class="error-message">Please select a constituency</span>
          }
        </div>

        <div class="form-group">
          <label for="ward">Ward</label>
          <select 
            id="ward"
            formControlName="ward"
            class="form-control"
            [class.error]="profileForm.get('ward')?.invalid && profileForm.get('ward')?.touched"
          >
            <option value="">
              {{ !profileForm.get('constituency')?.value ? 'Select constituency first' : 'Select Ward' }}
            </option>
            @for (ward of wards; track ward) {
              <option [value]="ward">
                {{ ward }}
              </option>
            }
          </select>
          @if (profileForm.get('ward')?.invalid && profileForm.get('ward')?.touched) {
            <span class="error-message">Please select a ward</span>
          }
        </div>

        <button type="submit" class="submit-btn" [disabled]="isSaving()">
          @if (isSaving()) {
            <span class="btn-spinner"></span>
            <span>Saving...</span>
          } @else {
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
              <polyline points="17 21 17 13 7 13 7 21"></polyline>
              <polyline points="7 3 7 8 15 8"></polyline>
            </svg>
            <span>Save Changes</span>
          }
        </button>
      </form>
    </div>
  }
</div>