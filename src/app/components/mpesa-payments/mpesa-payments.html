<div class="mpesa-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-icon">
        <span class="material-icons">phone_android</span>
      </div>
      <div class="header-text">
        <h1>M-Pesa Messages</h1>
        <p>View and manage your mobile money transactions</p>
      </div>
    </div>
    <div class="header-actions">
      <button class="action-btn" (click)="openFilterDialog()" title="Filter">
        <span class="material-icons">filter_list</span>
        <span class="btn-text">Filter</span>
      </button>
      <button class="action-btn" (click)="loadMpesaMessages()" title="Refresh">
        <span class="material-icons">refresh</span>
        <span class="btn-text">Refresh</span>
      </button>
    </div>
  </div>

  <!-- Info Card -->
  <div class="info-card">
    <div class="info-icon">
      <span class="material-icons">phone_android</span>
    </div>
    <div class="info-content">
      <h3>M-Pesa Transactions</h3>
      <p>View and manage your mobile money transactions</p>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="spinner"></div>
    <p>Loading transactions...</p>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && filteredMessages.length === 0" class="empty-state">
    <div class="empty-icon">
      <span class="material-icons">receipt_long</span>
    </div>
    <h2>No Transactions Found</h2>
    <p>No M-Pesa transactions match your search criteria</p>
  </div>

  <!-- Transaction List -->
  <div *ngIf="!isLoading && filteredMessages.length > 0" class="transactions-section">
    <div class="section-header">
      <div class="section-title">
        <span class="material-icons">list_alt</span>
        <h2>Transaction History ({{ filteredMessages.length }})</h2>
      </div>
    </div>

    <div class="transactions-grid">
      <div *ngFor="let msg of filteredMessages" class="transaction-card">
        <!-- Header with amount and status -->
        <div class="transaction-header">
          <div class="amount-section">
            <div class="amount-icon">
              <span class="material-icons">phone_android</span>
            </div>
            <span class="amount">KES {{ msg.amount }}</span>
          </div>
          <div class="status-badge completed">
            <span class="material-icons">check_circle</span>
            <span>Completed</span>
          </div>
        </div>

        <!-- Transaction Details -->
        <div class="transaction-details">
          <div class="detail-box phone-detail">
            <div class="detail-row">
              <span class="material-icons">phone</span>
              <span class="detail-label">Phone:</span>
              <span class="detail-value">{{ formatPhone(msg.phone_number) }}</span>
            </div>
            <div class="detail-row">
              <span class="material-icons">receipt_long</span>
              <span class="detail-label">Receipt:</span>
              <span class="detail-value">{{ msg.mpesa_receipt_number }}</span>
            </div>
          </div>

          <div class="detail-box date-detail">
            <div class="detail-row">
              <span class="material-icons">access_time</span>
              <span class="detail-label">Date:</span>
              <span class="detail-value">{{ formatDate(msg.transaction_date) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Action Button -->
  <button class="fab" (click)="openPaymentDialog()">
    <span class="material-icons">add</span>
    <span class="fab-text">Add Payment</span>
  </button>
</div>

<!-- Payment Dialog -->
<div class="dialog-overlay" *ngIf="showPaymentDialog" (click)="closePaymentDialog()">
  <div class="dialog" (click)="$event.stopPropagation()">
    <div class="dialog-header">
      <div class="dialog-title">
        <div class="dialog-icon">
          <span class="material-icons">payment</span>
        </div>
        <h2>Add New Payment</h2>
      </div>
      <button class="close-btn" (click)="closePaymentDialog()">
        <span class="material-icons">close</span>
      </button>
    </div>

    <div class="dialog-body">
      <form (ngSubmit)="sendStkPush()">
        <div class="form-group">
          <label for="phoneNumber">
            <span class="material-icons">phone</span>
            Phone Number
          </label>
          <input 
            type="tel" 
            id="phoneNumber" 
            [(ngModel)]="paymentForm.phoneNumber" 
            name="phoneNumber"
            placeholder="0712345678"
            required
          />
        </div>

        <div class="form-group">
          <label for="amount">
            <span class="material-icons">money</span>
            Amount (KES)
          </label>
          <input 
            type="number" 
            id="amount" 
            [(ngModel)]="paymentForm.amount" 
            name="amount"
            placeholder="Enter amount"
            required
          />
        </div>

        <div class="dialog-footer">
          <button type="button" class="cancel-btn" (click)="closePaymentDialog()" [disabled]="saving">
            Cancel
          </button>
          <button type="submit" class="submit-btn" [disabled]="saving">
            <span *ngIf="!saving">Send STK Push</span>
            <span *ngIf="saving">Sending...</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Filter Dialog -->
<div class="dialog-overlay" *ngIf="showFilterDialog" (click)="closeFilterDialog()">
  <div class="dialog" (click)="$event.stopPropagation()">
    <div class="dialog-header">
      <div class="dialog-title">
        <div class="dialog-icon">
          <span class="material-icons">filter_list</span>
        </div>
        <h2>Filter Messages</h2>
      </div>
      <button class="close-btn" (click)="closeFilterDialog()">
        <span class="material-icons">close</span>
      </button>
    </div>

    <div class="dialog-body">
      <form (ngSubmit)="applyFilters()">
        <div class="form-group">
          <label for="filterPhone">
            <span class="material-icons">phone</span>
            Phone Number
          </label>
          <input 
            type="tel" 
            id="filterPhone" 
            [(ngModel)]="filterForm.phone" 
            name="filterPhone"
            placeholder="Filter by phone"
          />
        </div>

        <div class="form-group">
          <label for="filterAmount">
            <span class="material-icons">money</span>
            Amount
          </label>
          <input 
            type="number" 
            id="filterAmount" 
            [(ngModel)]="filterForm.amount" 
            name="filterAmount"
            placeholder="Filter by amount"
          />
        </div>

        <div class="form-group">
          <label for="filterReceipt">
            <span class="material-icons">receipt</span>
            Receipt Number
          </label>
          <input 
            type="text" 
            id="filterReceipt" 
            [(ngModel)]="filterForm.receipt" 
            name="filterReceipt"
            placeholder="Filter by receipt"
          />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="startDate">
              <span class="material-icons">calendar_today</span>
              Start Date
            </label>
            <input 
              type="date" 
              id="startDate" 
              [(ngModel)]="filterForm.startDate" 
              name="startDate"
            />
          </div>

          <div class="form-group">
            <label for="endDate">
              <span class="material-icons">calendar_today</span>
              End Date
            </label>
            <input 
              type="date" 
              id="endDate" 
              [(ngModel)]="filterForm.endDate" 
              name="endDate"
            />
          </div>
        </div>

        <div class="dialog-footer">
          <button type="button" class="cancel-btn" (click)="clearFilters()">
            Clear All
          </button>
          <button type="submit" class="submit-btn">
            Apply Filters
          </button>
        </div>
      </form>
    </div>
  </div>
</div>